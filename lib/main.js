// Generated by IcedCoffeeScript 1.7.1-b
(function() {
  var ArgumentParser, Main, PackageJson, Summarizer, constants, fs, iced, __iced_k, __iced_k_noop;

  iced = require('iced-coffee-script/lib/coffee-script/iced').runtime;
  __iced_k = __iced_k_noop = function() {};

  ArgumentParser = require('argparse').ArgumentParser;

  PackageJson = require('./package').PackageJson;

  Summarizer = require('./summarizer').Summarizer;

  constants = require('./constants');

  fs = require('fs');

  Main = (function() {
    function Main() {
      this.pkjson = new PackageJson();
      this.args = null;
      this.init_parser();
    }

    Main.prototype.exit_err = function(e) {
      console.log("Error: " + (e.toString()));
      return process.exit(1);
    };

    Main.prototype.init_parser = function() {
      var sign, subparsers, verify;
      this.ap = new ArgumentParser({
        addHelp: true,
        version: this.pkjson.version(),
        description: 'keybase.io directory summarizer',
        prog: this.pkjson.bin()
      });
      subparsers = this.ap.addSubparsers({
        title: 'subcommands',
        dest: 'subcommand_name'
      });
      sign = subparsers.addParser('sign', {
        addHelp: true
      });
      verify = subparsers.addParser('verify', {
        addHelp: true
      });
      sign.addArgument(['-o', '--output'], {
        action: 'store',
        type: 'string',
        help: 'output to a specific file'
      });
      sign.addArgument(['-p', '--preset'], {
        action: 'store',
        type: 'string',
        help: 'use an ignore preset'
      });
      sign.addArgument(['-d', '--dir'], {
        action: 'store',
        type: 'string',
        help: 'the directory to sign',
        defaultValue: '.'
      });
      verify.addArgument(['-i', '--input'], {
        action: 'store',
        type: 'string',
        help: 'load a specific signature file'
      });
      return verify.addArgument(['-d', '--dir'], {
        action: 'store',
        type: 'string',
        help: 'the directory to verify',
        defaultValue: '.'
      });
    };

    Main.prototype.sign = function() {
      var err, output, summ, ___iced_passed_deferral, __iced_deferrals, __iced_k;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      output = this.args.output || constants.defaults.filename;
      (function(_this) {
        return (function(__iced_k) {
          __iced_deferrals = new iced.Deferrals(__iced_k, {
            parent: ___iced_passed_deferral,
            filename: "/Users/chris/git/keybase/dir-summarize/src/main.iced",
            funcname: "Main.sign"
          });
          Summarizer.from_dir(_this.args.dir, {
            exclude: [output]
          }, __iced_deferrals.defer({
            assign_fn: (function() {
              return function() {
                err = arguments[0];
                return summ = arguments[1];
              };
            })(),
            lineno: 46
          }));
          __iced_deferrals._fulfill();
        });
      })(this)((function(_this) {
        return function() {
          if (typeof err !== "undefined" && err !== null) {
            exit_err(err);
          }
          (function(__iced_k) {
            __iced_deferrals = new iced.Deferrals(__iced_k, {
              parent: ___iced_passed_deferral,
              filename: "/Users/chris/git/keybase/dir-summarize/src/main.iced",
              funcname: "Main.sign"
            });
            fs.writeFile(output, summ.to_str() + "\n", {
              encoding: 'utf8'
            }, __iced_deferrals.defer({
              assign_fn: (function() {
                return function() {
                  return err = arguments[0];
                };
              })(),
              lineno: 48
            }));
            __iced_deferrals._fulfill();
          })(function() {
            if (typeof err !== "undefined" && err !== null) {
              return exit_err(err);
            }
          });
        };
      })(this));
    };

    Main.prototype.run = function() {
      this.args = this.ap.parseArgs();
      switch (this.args.subcommand_name) {
        case 'sign':
          return this.sign();
        case 'verify':
          return this.verify();
      }
    };

    return Main;

  })();

  exports.run = function() {
    var m;
    m = new Main();
    return m.run();
  };

}).call(this);
